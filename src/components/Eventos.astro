---
import { db } from "../lib/firebase/server";

// Obtener eventos de Firestore
let eventos = {}; 
try {
  const snapshot = await db.collection("calendar_events").where("type", "==", "event").get();
  
  // Agrupar por fecha
  snapshot.docs.forEach(doc => {
    const data = doc.data();
    const fecha = data.date;
    
    if (!eventos[fecha]) {
      eventos[fecha] = [];
    }
    
    eventos[fecha].push({
      titulo: data.title,
      hora: data.time || "",
      detalles: data.details || ""
    });
  });
} catch (error) {
  console.error("Error fetching events:", error);
  eventos = {};
}

// Función para generar los días del mes
function generarDiasMes(año, mes) {
    const diasEnMes = new Date(año, mes, 0).getDate();
    const primerDia = new Date(año, mes - 1, 1).getDay();
    const espaciosVacios = primerDia === 0 ? 6 : primerDia - 1;

    const dias = [];

    // Días vacíos
    for (let i = 0; i < espaciosVacios; i++) {
        dias.push({ vacio: true });
    }

    // Días del mes
    for (let dia = 1; dia <= diasEnMes; dia++) {
        const fecha = `${año}-${mes.toString().padStart(2, "0")}-${dia.toString().padStart(2, "0")}`;
        const evento = eventos[fecha];

        dias.push({
            numero: dia,
            fecha: fecha,
            evento: evento || null,
            vacio: false,
        });
    }

    // Completar la última semana si es necesario
    while (dias.length % 7 !== 0) {
        dias.push({ vacio: true });
    }

    return dias;
}

// Generar calendarios para cada mes
const enero = generarDiasMes(2026, 1);
const febrero = generarDiasMes(2026, 2);
const marzo = generarDiasMes(2026, 3);

// Función para dividir en semanas
function dividirEnSemanas(dias) {
    const semanas = [];
    for (let i = 0; i < dias.length; i += 7) {
        semanas.push(dias.slice(i, i + 7));
    }
    return semanas;
}
---

<section class="calendario-section section-eventos" id="eventos">
    <div class="container">
        <div class="section-header">
            <h2 class="section-title">Calendario de Eventos</h2>
            <div class="header-actions">
                <p class="section-subtitle">2º Trimestre</p>
                <button id="export-pdf-events-btn" class="export-btn">
                    <i class="fa-solid fa-file-pdf"></i> Exportar a PDF
                </button>
            </div>
        </div>

        <div class="calendario-container">
            <!-- Datos de eventos para el script del cliente -->
            <script
                type="application/json"
                id="eventos-public-data"
                is:inline
                set:html={JSON.stringify(eventos)}
            />

            <div class="meses-grid">
                <!-- Enero -->
                <div class="mes">
                    <h3 class="mes-titulo">Enero 2026</h3>
                    <table class="calendario-tabla">
                        <thead>
                            <tr>
                                <th>L</th>
                                <th>M</th>
                                <th>X</th>
                                <th>J</th>
                                <th>V</th>
                                <th>S</th>
                                <th>D</th>
                            </tr>
                        </thead>
                        <tbody>
                            {
                                dividirEnSemanas(enero).map((semana) => (
                                    <tr>
                                        {semana.map((dia) => (
                                            <td
                                                class={
                                                    dia.vacio
                                                        ? "dia-vacio"
                                                        : dia.evento
                                                          ? "dia tiene-evento"
                                                          : "dia"
                                                }
                                                data-evento-fecha={
                                                    dia.evento
                                                        ? dia.fecha
                                                        : null
                                                }
                                            >
                                                {!dia.vacio && (
                                                    <>
                                                        <div class="numero-dia">
                                                            {dia.numero}
                                                        </div>
                                                        {dia.evento &&
                                                            dia.evento.length >
                                                                0 && (
                                                                <div class="examen-info">
                                                                    <div class="asignatura">
                                                                        {
                                                                            dia
                                                                                .evento[0]
                                                                                .titulo
                                                                        }
                                                                    </div>
                                                                    {dia.evento
                                                                        .length >
                                                                        1 && (
                                                                        <div class="asignatura">
                                                                            {
                                                                                dia
                                                                                    .evento[1]
                                                                                    .titulo
                                                                            }
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            )}
                                                    </>
                                                )}
                                            </td>
                                        ))}
                                    </tr>
                                ))
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Febrero -->
                <div class="mes">
                    <h3 class="mes-titulo">Febrero 2026</h3>
                    <table class="calendario-tabla">
                        <thead>
                            <tr>
                                <th>L</th>
                                <th>M</th>
                                <th>X</th>
                                <th>J</th>
                                <th>V</th>
                                <th>S</th>
                                <th>D</th>
                            </tr>
                        </thead>
                        <tbody>
                            {
                                dividirEnSemanas(febrero).map((semana) => (
                                    <tr>
                                        {semana.map((dia) => (
                                            <td
                                                class={
                                                    dia.vacio
                                                        ? "dia-vacio"
                                                        : dia.evento
                                                          ? "dia tiene-evento"
                                                          : "dia"
                                                }
                                                data-evento-fecha={
                                                    dia.evento
                                                        ? dia.fecha
                                                        : null
                                                }
                                            >
                                                {!dia.vacio && (
                                                    <>
                                                        <div class="numero-dia">
                                                            {dia.numero}
                                                        </div>
                                                        {dia.evento &&
                                                            dia.evento.length >
                                                                0 && (
                                                                <div class="examen-info">
                                                                    <div class="asignatura">
                                                                        {
                                                                            dia
                                                                                .evento[0]
                                                                                .titulo
                                                                        }
                                                                    </div>
                                                                    {dia.evento
                                                                        .length >
                                                                        1 && (
                                                                        <div class="asignatura">
                                                                            {
                                                                                dia
                                                                                    .evento[1]
                                                                                    .titulo
                                                                            }
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            )}
                                                    </>
                                                )}
                                            </td>
                                        ))}
                                    </tr>
                                ))
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Marzo -->
                <div class="mes">
                    <h3 class="mes-titulo">Marzo 2026</h3>
                    <table class="calendario-tabla">
                        <thead>
                            <tr>
                                <th>L</th>
                                <th>M</th>
                                <th>X</th>
                                <th>J</th>
                                <th>V</th>
                                <th>S</th>
                                <th>D</th>
                            </tr>
                        </thead>
                        <tbody>
                            {
                                dividirEnSemanas(marzo).map((semana) => (
                                    <tr>
                                        {semana.map((dia) => (
                                            <td
                                                class={
                                                    dia.vacio
                                                        ? "dia-vacio"
                                                        : dia.evento
                                                          ? "dia tiene-evento"
                                                          : "dia"
                                                }
                                                data-evento-fecha={
                                                    dia.evento
                                                        ? dia.fecha
                                                        : null
                                                }
                                            >
                                                {!dia.vacio && (
                                                    <>
                                                        <div class="numero-dia">
                                                            {dia.numero}
                                                        </div>
                                                        {dia.evento &&
                                                            dia.evento.length >
                                                                0 && (
                                                                <div class="examen-info">
                                                                    <div class="asignatura">
                                                                        {
                                                                            dia
                                                                                .evento[0]
                                                                                .titulo
                                                                        }
                                                                    </div>
                                                                    {dia.evento
                                                                        .length >
                                                                        1 && (
                                                                        <div class="asignatura">
                                                                            {
                                                                                dia
                                                                                    .evento[1]
                                                                                    .titulo
                                                                            }
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            )}
                                                    </>
                                                )}
                                            </td>
                                        ))}
                                    </tr>
                                ))
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>

<div
    id="evento-modal"
    class="modal-overlay modal-eventos"
    style="display: none;"
>
    <div class="modal-content">
        <button id="modal-evento-close" class="modal-close">&times;</button>
        <h3 id="modal-evento-fecha-titulo"></h3>
        <div id="modal-eventos-lista"></div>
    </div>
</div>

<style is:global>
    /* Aseguramos que los eventos públicos sean azules */
    .dia.tiene-evento {
        background: linear-gradient(45deg, #2000ad, #003d99);
        color: white;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .dia.tiene-evento:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 20px rgba(0, 30, 96, 0.3);
    }

    .dia.tiene-evento .numero-dia {
        color: white;
    }

    /* Estilos mejorados para el modal de eventos */
    .modal-eventos .modal-content {
        background: white;
        padding: 40px !important;
        border-radius: 20px;
        width: 95%;
        max-width: 550px;
        position: relative;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        animation: fadeIn 0.3s ease-out;
        box-sizing: border-box;
    }

    #modal-evento-fecha-titulo {
        font-size: 1.8rem;
        font-weight: 800;
        color: #2000ad;
        margin-bottom: 25px;
        padding-right: 35px; /* Espacio para la X */
        line-height: 1.2;
        word-wrap: break-word;
    }

    .evento-item {
        border-bottom: 1px solid #e2e8f0;
        padding: 20px 0;
    }
    .evento-item:last-child {
        border-bottom: none;
    }

    .evento-item h4 {
        font-size: 1.5rem;
        color: #1e293b;
        margin-bottom: 12px;
        font-weight: 700;
        line-height: 1.3;
    }

    .evento-item p {
        margin: 8px 0;
        font-size: 1rem;
        color: #475569;
    }

    .evento-item strong {
        color: #2000ad;
        font-weight: 600;
    }

    .detalles-container {
        margin-top: 15px;
        background: #f8fafc;
        padding: 15px;
        border-radius: 12px;
        border-left: 4px solid #2000ad;
    }

    .detalles-label {
        display: block;
        font-weight: 700;
        color: #2000ad;
        margin-bottom: 8px;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .detalles-html {
        line-height: 1.6;
        color: #334155;
    }

    /* Estilos para el contenido Quill dentro del modal */
    .detalles-html p { margin-bottom: 10px; }
    .detalles-html ul { padding-left: 20px; margin-bottom: 10px; }
    .detalles-html li { margin-bottom: 5px; }
</style>

<script>
    import { jsPDF } from "jspdf";
    import autoTable from "jspdf-autotable";

    document.addEventListener("DOMContentLoaded", () => {
        const modal = document.getElementById("evento-modal");
        const modalClose = document.getElementById("modal-evento-close");
        const modalFechaTitulo = document.getElementById("modal-evento-fecha-titulo");
        const modalEventosLista = document.getElementById("modal-eventos-lista");
        const exportBtn = document.getElementById("export-pdf-events-btn");

        const eventosDataElement = document.getElementById("eventos-public-data");
        const eventos = JSON.parse(eventosDataElement?.textContent || "{}");

        exportBtn?.addEventListener("click", () => {
            try {
                const doc = new jsPDF();

                doc.setFontSize(18);
                doc.setTextColor(32, 0, 173);
                doc.text("Calendario de Eventos - 1B Bach", 14, 20);

                doc.setFontSize(12);
                doc.setTextColor(100, 116, 139);
                doc.text("2º Trimestre - Curso 2025/2026", 14, 28);

                const tableRows = [];
                const fechasOrdenadas = Object.keys(eventos).sort();

                fechasOrdenadas.forEach((fecha) => {
                    const fechaFormateada = new Date(
                        fecha + "T00:00:00",
                    ).toLocaleDateString("es-ES", {
                        day: "2-digit",
                        month: "2-digit",
                        year: "numeric",
                    });

                    eventos[fecha].forEach((evento: any) => {
                        tableRows.push([
                            fechaFormateada,
                            evento.titulo,
                            evento.hora || "Todo el día",
                            evento.detalles.replace(/<[^>]*>?/gm, '') || "-",
                        ]);
                    });
                });

                autoTable(doc, {
                    head: [["Fecha", "Evento", "Hora", "Detalles"]],
                    body: tableRows,
                    startY: 35,
                    theme: "striped",
                    headStyles: { fillColor: [32, 0, 173] },
                    styles: { fontSize: 9, cellPadding: 3 },
                    columnStyles: {
                        0: { cellWidth: 25 },
                        1: { cellWidth: 50 },
                        2: { cellWidth: 30 },
                        3: { cellWidth: "auto" },
                    },
                });

                doc.save("eventos-1b-bach.pdf");
            } catch (error) {
                console.error("Error al generar PDF:", error);
                alert("Hubo un error al generar el PDF.");
            }
        });

        document.querySelectorAll(".tiene-evento").forEach((celda) => {
            celda.addEventListener("click", () => {
                const fecha = (celda as HTMLElement).dataset.eventoFecha;
                if (fecha && eventos[fecha] && eventos[fecha].length > 0) {
                    const eventosDelDia = eventos[fecha];
                    modalFechaTitulo!.textContent = new Date(
                        fecha + "T00:00:00",
                    ).toLocaleDateString("es-ES", {
                        day: "numeric",
                        month: "long",
                        year: "numeric",
                    });
                    modalEventosLista!.innerHTML = "";

                    eventosDelDia.forEach((evento: any) => {
                        const eventoDiv = document.createElement("div");
                        eventoDiv.classList.add("evento-item");

                        eventoDiv.innerHTML = `
                            <h4>${evento.titulo}</h4>
                            <p><strong>Hora:</strong> ${evento.hora || "Todo el día"}</p>
                            <div class="detalles-container">
                                <span class="detalles-label">Detalles</span>
                                <div class="detalles-html">${evento.detalles || "No hay detalles adicionales."}</div>
                            </div>
                        `;

                        modalEventosLista!.appendChild(eventoDiv);
                    });

                    modal!.style.display = "flex";
                }
            });
        });

        function closeModal() {
            modal!.style.display = "none";
        }

        modalClose?.addEventListener("click", closeModal);
        modal?.addEventListener("click", (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
                closeModal();
            }
        });
    });
</script>
